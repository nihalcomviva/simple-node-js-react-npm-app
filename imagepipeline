pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'localhost:5000'
        DOCKER_CREDENTIALS_ID = 'local-docker-registry'
        MONGO_INITDB_DATABASE = 'mydatabase'
        MONGO_INITDB_ROOT_USERNAME = 'ati'
        MONGO_INITDB_ROOT_PASSWORD = 'ati1234'
        MONGO_EXPRESS_USERNAME = 'ati'
        MONGO_EXPRESS_PASSWORD = 'ati1234'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'master', url: 'https://github.com/nihalcomviva/simple-node-js-react-npm-app.git'
            }
        }

        stage('Pull Base Images') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh 'docker pull postgres:latest'
                        sh 'docker pull redis:latest'
                        sh 'docker pull mongo:latest'
                        sh 'docker pull mongo-express:latest'
                    }
                }
            }
        }

        stage('Build Images') {
            steps {
                script {
                    // Check if Dockerfiles exist in respective directories
                    def postgresDockerfile = fileExists('postgres/Dockerfile.postgres') ? 'postgres/Dockerfile.postgres' : 'postgres/Dockerfile'
                    def redisDockerfile = fileExists('redis/Dockerfile.redis') ? 'redis/Dockerfile.redis' : 'redis/Dockerfile'
                    def mongoDockerfile = fileExists('mongo/Dockerfile.mongo') ? 'mongo/Dockerfile.mongo' : 'mongo/Dockerfile'
                    def mongoExpressDockerfile = fileExists('mongo-express/Dockerfile.mongo-express') ? 'mongo-express/Dockerfile.mongo-express' : 'mongo-express/Dockerfile'

                    // Build Postgres image
                    sh "docker build -t ${DOCKER_REGISTRY}/my-postgres-image -f ${postgresDockerfile} postgres/"

                    // Build Redis image
                    sh "docker build -t ${DOCKER_REGISTRY}/my-redis-image -f ${redisDockerfile} redis/"

                    // Build Mongo image
                    sh "docker build -t ${DOCKER_REGISTRY}/my-mongo-image -f ${mongoDockerfile} mongo/"

                    // Build Mongo Express image
                    sh "docker build -t ${DOCKER_REGISTRY}/my-mongo-express-image -f ${mongoExpressDockerfile} mongo-express/"
                }
            }
        }

        stage('Push Images to Local Registry') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh "docker tag my-postgres-image ${DOCKER_REGISTRY}/my-postgres-image:latest"
                        sh "docker push ${DOCKER_REGISTRY}/my-postgres-image:latest"

                        sh "docker tag my-redis-image ${DOCKER_REGISTRY}/my-redis-image:latest"
                        sh "docker push ${DOCKER_REGISTRY}/my-redis-image:latest"

                        sh "docker tag my-mongo-image ${DOCKER_REGISTRY}/my-mongo-image:latest"
                        sh "docker push ${DOCKER_REGISTRY}/my-mongo-image:latest"

                        sh "docker tag my-mongo-express-image ${DOCKER_REGISTRY}/my-mongo-express-image:latest"
                        sh "docker push ${DOCKER_REGISTRY}/my-mongo-express-image:latest"
                    }
                }
            }
        }

        stage('Configure and Run Containers') {
            steps {
                script {
                    // Run Postgres container
                    sh '''
                    docker run -d \
                        -e POSTGRES_PASSWORD=mysecretpassword \
                        -e POSTGRES_DB=${MONGO_INITDB_DATABASE} \
                        --name postgres-db \
                        ${DOCKER_REGISTRY}/my-postgres-image:latest
                    '''

                    // Run Redis container
                    sh '''
                    docker run -d \
                        --name redis-db \
                        ${DOCKER_REGISTRY}/my-redis-image:latest
                    '''

                    // Run Mongo container
                    sh '''
                    docker run -d \
                        -e MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME} \
                        -e MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD} \
                        --name mongo-db \
                        ${DOCKER_REGISTRY}/my-mongo-image:latest
                    '''

                    // Run Mongo Express container
                    sh '''
                    docker run -d \
                        -e ME_CONFIG_MONGODB_SERVER=mongo-db \
                        -e ME_CONFIG_MONGODB_ADMINUSERNAME=${MONGO_EXPRESS_USERNAME} \
                        -e ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_EXPRESS_PASSWORD} \
                        --name mongo-express-app \
                        -p 8081:8081 \
                        ${DOCKER_REGISTRY}/my-mongo-express-image:latest
                    '''
                }
            }
        }
    }
}

// Function to check if file exists
def fileExists(filePath) {
    return readFile(filePath) != null
}

